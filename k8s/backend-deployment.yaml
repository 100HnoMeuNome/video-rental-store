apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: video-rental
data:
  PORT: "5000"
  MONGODB_URI: "mongodb://mongo:27017/video-rental"
  NODE_ENV: "production"
  APP_VERSION: "1.0.0"
  DD_AGENT_HOST: "datadog-agent"
  DD_TRACE_AGENT_PORT: "8126"
  DD_SERVICE: "video-rental-api"
  DD_ENV: "production"
  DD_VERSION: "1.0.0"
  DD_LOGS_INJECTION: "true"
  DD_RUNTIME_METRICS_ENABLED: "true"
  DD_PROFILING_ENABLED: "true"
  DD_APPSEC_ENABLED: "true"
---
apiVersion: v1
kind: Secret
metadata:
  name: backend-secret
  namespace: video-rental
type: Opaque
stringData:
  JWT_SECRET: "a7ed710b0fd6824454232d38d366531c550417c15464259b65328e43637e4602dd7027bb7f571fb67cf6e1d9a1c3e1e77f5a0d059d19c74172ec6f655c86020a"
  DD_API_KEY: "YOUR_DATADOG_API_KEY_HERE"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: video-rental
  labels:
    app: backend
    tags.datadoghq.com/env: "production"
    tags.datadoghq.com/service: "video-rental-api"
    tags.datadoghq.com/version: "1.0.0"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
        tags.datadoghq.com/env: "production"
        tags.datadoghq.com/service: "video-rental-api"
        tags.datadoghq.com/version: "1.0.0"
      annotations:
        ad.datadoghq.com/backend.logs: '[{"source":"nodejs","service":"video-rental-api"}]'
    spec:
      containers:
      - name: backend
        image: video-rental-backend:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 5000
        envFrom:
        - configMapRef:
            name: backend-config
        env:
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: JWT_SECRET
        - name: DD_API_KEY
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: DD_API_KEY
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 10
          periodSeconds: 5
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: video-rental
spec:
  selector:
    app: backend
  ports:
  - port: 5000
    targetPort: 5000
  type: ClusterIP
