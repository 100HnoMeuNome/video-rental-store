<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Movie - Checkout</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1><a href="index.html">Video Rental Store</a></h1>
            <div id="userNav">
                <span id="usernameDisplay"></span>
                <a href="my-rentals.html">My Rentals</a>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="checkout-container">
            <h2>Buy Movie - Checkout</h2>

            <div class="checkout-summary" id="movieSummary">
                <!-- Movie details will be loaded here -->
            </div>

            <form id="buyCheckoutForm" onsubmit="handleBuyCheckout(event)">
                <div class="form-section">
                    <h3>Payment Information</h3>
                    <p class="section-note">Secure payment processing. Your card is never stored.</p>

                    <div class="form-group">
                        <label for="cardHolderName">Cardholder Name *</label>
                        <input type="text" id="cardHolderName" required placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="cardNumber">Card Number *</label>
                        <input type="text" id="cardNumber" required placeholder="1234 5678 9012 3456"
                               maxlength="19" pattern="[0-9\s]{13,19}">
                        <small class="card-icons">
                            ðŸ’³ Visa, Mastercard, American Express, Discover accepted
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date *</label>
                            <input type="text" id="expiryDate" required placeholder="MM/YY"
                                   maxlength="5" pattern="[0-9]{2}/[0-9]{2}">
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV *</label>
                            <input type="text" id="cvv" required placeholder="123"
                                   maxlength="4" pattern="[0-9]{3,4}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="billingZip">Billing ZIP Code *</label>
                        <input type="text" id="billingZip" required placeholder="90001"
                               pattern="[0-9]{5}" maxlength="5">
                    </div>
                </div>

                <div class="form-section">
                    <div class="purchase-info">
                        <h4>Purchase Details:</h4>
                        <ul>
                            <li><strong>Format:</strong> Digital Download (HD)</li>
                            <li><strong>Access:</strong> Lifetime streaming</li>
                            <li><strong>Devices:</strong> Stream on up to 5 devices</li>
                            <li><strong>Quality:</strong> 1080p HD</li>
                            <li><strong>Download:</strong> Available for offline viewing</li>
                        </ul>
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreeTerms" required>
                            I agree to the terms of service and purchase policy
                        </label>
                    </div>
                </div>

                <div class="checkout-total">
                    <div class="total-row">
                        <span>Movie Price:</span>
                        <span id="moviePrice">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Tax:</span>
                        <span id="taxAmount">$0.00</span>
                    </div>
                    <div class="total-row total-final">
                        <span><strong>Total:</strong></span>
                        <span id="totalAmount"><strong>$0.00</strong></span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="window.history.back()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Complete Purchase</button>
                </div>

                <div id="message"></div>
            </form>

            <div class="security-notice">
                <p>ðŸ”’ Your payment is secure and encrypted. We never store your full card number.</p>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        checkAuth();

        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }

        // Get movie ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');

        if (!movieId) {
            alert('No movie selected');
            window.location.href = 'index.html';
        }

        let moviePrice = 0;
        const TAX_RATE = 0.08; // 8% tax

        // Load movie details
        async function loadMovieDetails() {
            try {
                const response = await fetch(`${API_URL}/api/movies/${movieId}`);
                const movie = await response.json();

                if (response.ok) {
                    moviePrice = movie.pricing.buy;
                    const tax = moviePrice * TAX_RATE;
                    const total = moviePrice + tax;

                    document.getElementById('movieSummary').innerHTML = `
                        <div class="movie-summary-card">
                            <h3>${movie.title}</h3>
                            <p><strong>Director:</strong> ${movie.director}</p>
                            <p><strong>Year:</strong> ${movie.releaseYear}</p>
                            <p><strong>Duration:</strong> ${movie.duration} minutes</p>
                            <p><strong>Genre:</strong> ${movie.genre}</p>
                            <p><strong>Rating:</strong> ${movie.rating}/10</p>
                        </div>
                    `;

                    document.getElementById('moviePrice').textContent = `$${moviePrice.toFixed(2)}`;
                    document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
                    document.getElementById('totalAmount').innerHTML = `<strong>$${total.toFixed(2)}</strong>`;
                } else {
                    alert('Error loading movie details');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                alert('Error connecting to server');
                window.location.href = 'index.html';
            }
        }

        loadMovieDetails();

        // Format card number with spaces
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Format expiry date
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        async function handleBuyCheckout(event) {
            event.preventDefault();

            const messageDiv = document.getElementById('message');
            const token = localStorage.getItem('token');

            // Get form data
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardType = detectCardType(cardNumber);

            const purchaseData = {
                movieId: movieId,
                type: 'buy',
                payment: {
                    cardHolderName: document.getElementById('cardHolderName').value,
                    cardNumber: cardNumber, // Will be masked on backend
                    cardType: cardType,
                    cvv: document.getElementById('cvv').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    billingZip: document.getElementById('billingZip').value
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/rentals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(purchaseData)
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<p class="success">Purchase completed successfully! Redirecting to your library...</p>';
                    setTimeout(() => {
                        window.location.href = 'my-rentals.html';
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<p class="error">Error processing purchase</p>';
            }
        }

        function detectCardType(cardNumber) {
            if (cardNumber.startsWith('4')) return 'Visa';
            if (cardNumber.startsWith('5')) return 'Mastercard';
            if (cardNumber.startsWith('3')) return 'American Express';
            if (cardNumber.startsWith('6')) return 'Discover';
            return 'Unknown';
        }
    </script>
</body>
</html>
