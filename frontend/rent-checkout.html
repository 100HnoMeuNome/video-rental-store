<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Insecure Rental</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1><a href="index.html">Insecure Rental</a></h1>
            <div id="userNav">
                <span id="usernameDisplay"></span>
                <a href="my-rentals.html">My Rentals</a>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="checkout-container">
            <h2>Rent Movie - Checkout</h2>

            <div class="checkout-summary" id="movieSummary">
                <!-- Movie details will be loaded here -->
            </div>

            <form id="rentCheckoutForm" onsubmit="handleRentCheckout(event)">
                <div class="form-section">
                    <h3>Shipping Address</h3>
                    <p class="section-note">Where should we ship the DVD?</p>

                    <div class="form-group">
                        <label for="street">Street Address *</label>
                        <input type="text" id="street" required placeholder="123 Main St, Apt 4B">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City *</label>
                            <input type="text" id="city" required placeholder="Los Angeles">
                        </div>
                        <div class="form-group">
                            <label for="state">State *</label>
                            <input type="text" id="state" required placeholder="CA">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode">ZIP Code *</label>
                            <input type="text" id="zipCode" required placeholder="90001" pattern="[0-9]{5}">
                        </div>
                        <div class="form-group">
                            <label for="country">Country *</label>
                            <input type="text" id="country" required placeholder="USA" value="USA">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Payment Information</h3>
                    <p class="section-note">Your payment is secure. Card details are not stored.</p>

                    <div class="form-group">
                        <label for="cardHolderName">Cardholder Name *</label>
                        <input type="text" id="cardHolderName" required placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="cardNumber">Card Number *</label>
                        <input type="text" id="cardNumber" required placeholder="1234 5678 9012 3456"
                               maxlength="19" pattern="[0-9\s]{13,19}">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiryDate">Expiry Date *</label>
                            <input type="text" id="expiryDate" required placeholder="MM/YY"
                                   maxlength="5" pattern="[0-9]{2}/[0-9]{2}">
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV *</label>
                            <input type="text" id="cvv" required placeholder="123"
                                   maxlength="4" pattern="[0-9]{3,4}">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="rental-terms">
                        <h4>Rental Terms:</h4>
                        <ul>
                            <li>Rental period: 7 days from delivery</li>
                            <li>DVD must be returned in original condition</li>
                            <li>Late fees apply after return date</li>
                            <li>A prepaid return envelope will be included</li>
                        </ul>
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreeTerms" required>
                            I agree to the rental terms and conditions
                        </label>
                    </div>
                </div>

                <div class="checkout-total">
                    <div class="total-row">
                        <span>Rental Fee:</span>
                        <span id="rentalFee">$0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Shipping:</span>
                        <span>FREE</span>
                    </div>
                    <div class="total-row total-final">
                        <span><strong>Total:</strong></span>
                        <span id="totalAmount"><strong>$0.00</strong></span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="window.history.back()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Complete Rental</button>
                </div>

                <div id="message"></div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        checkAuth();

        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }

        // Get movie ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');

        if (!movieId) {
            alert('No movie selected');
            window.location.href = 'index.html';
        }

        // Load movie details
        async function loadMovieDetails() {
            try {
                const response = await fetch(`${API_URL}/api/movies/${movieId}`);
                const movie = await response.json();

                if (response.ok) {
                    document.getElementById('movieSummary').innerHTML = `
                        <div class="movie-summary-card">
                            <h3>${movie.title}</h3>
                            <p><strong>Director:</strong> ${movie.director}</p>
                            <p><strong>Year:</strong> ${movie.releaseYear}</p>
                            <p><strong>Duration:</strong> ${movie.duration} minutes</p>
                            <p><strong>Genre:</strong> ${movie.genre}</p>
                        </div>
                    `;

                    document.getElementById('rentalFee').textContent = `$${movie.pricing.rent.toFixed(2)}`;
                    document.getElementById('totalAmount').innerHTML = `<strong>$${movie.pricing.rent.toFixed(2)}</strong>`;
                } else {
                    alert('Error loading movie details');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                alert('Error connecting to server');
                window.location.href = 'index.html';
            }
        }

        loadMovieDetails();

        // Format card number with spaces
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Format expiry date
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        async function handleRentCheckout(event) {
            event.preventDefault();

            const messageDiv = document.getElementById('message');
            const token = localStorage.getItem('token');

            // Get form data
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardType = detectCardType(cardNumber);

            const rentalData = {
                movieId: movieId,
                type: 'rent',
                shippingAddress: {
                    street: document.getElementById('street').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zipCode: document.getElementById('zipCode').value,
                    country: document.getElementById('country').value
                },
                payment: {
                    cardHolderName: document.getElementById('cardHolderName').value,
                    cardNumber: cardNumber, // Will be masked on backend
                    cardType: cardType,
                    cvv: document.getElementById('cvv').value,
                    expiryDate: document.getElementById('expiryDate').value
                }
            };

            try {
                const response = await fetch(`${API_URL}/api/rentals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(rentalData)
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<p class="success">Rental completed successfully!</p>';
                    setTimeout(() => {
                        window.location.href = 'my-rentals.html';
                    }, 1500);
                } else {
                    messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<p class="error">Error processing rental</p>';
            }
        }

        function detectCardType(cardNumber) {
            if (cardNumber.startsWith('4')) return 'Visa';
            if (cardNumber.startsWith('5')) return 'Mastercard';
            if (cardNumber.startsWith('3')) return 'American Express';
            if (cardNumber.startsWith('6')) return 'Discover';
            return 'Unknown';
        }
    </script>
</body>
</html>
